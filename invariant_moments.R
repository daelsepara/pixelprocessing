mpq <- function(f, p_, q_) {
	
	size = dim(f)
	
	x = array(1:size[1])
	y = array(1:size[2])
	
	return(sum(outer(x^p_,y^q_)*f))
}

upq <- function(f, p_, q_) {

	m00 = mpq(f,0,0)
	x_ = mpq(f,1,0)/m00
	y_ = mpq(f,0,1)/m00
	
	size = dim(f)
	
	x = array(1:size[1])
	y = array(1:size[2])

	return(sum(outer((x-x_)^p_,(y-y_)^q_)*f))
}

npq <- function(f, p_, q_) {
	
	g = (p_ + q_)/2 + 1
	
	return(upq(f,p_,q_)/(upq(f,0,0)^g))
}

phi <- function(f) {
  
	phi_ = array(0,7)
	
	n02 = npq(f,0,2)
	n03 = npq(f,0,3)
	n11 = npq(f,1,1)
	n12 = npq(f,1,2)
	n20 = npq(f,2,0)
	n21 = npq(f,2,1)
	n30 = npq(f,3,0)
	
	n411 = 4*n11
	n4112 = 4*n11^2
	n0312 = n03 + n12
	n2002 = n20 - n02
	n2103 = n21 + n03
	n3012 = n30 + n12
	n20022 = n2002^2
	n21032 = n2103^2
	n30122 = n3012^2
	n30312 = n30 - 3*n12
	n31230 = 3*n12 - n30
	n32103 = 3*n21 - n03
	n303122 = n30312^2
	n321032 = n32103^2
	n30122103 = n30122 - n21032
	n301232103 = n30122 - 3*n21032
	n33012221032 = 3*n30122 - n21032
	
	phi_[1] = n20 + n02

	phi_[2] = n20022 + n4112

	phi_[3] = n303122 + n321032

	phi_[4] = n30122 + n21032
	
	phi_[5] = n30312 * n3012 * n301232103 + n32103 * n2103 * n33012221032
	
	phi_[6] = n2002 * n30122103 + n411 * n3012 * n2103
	
	phi_[7] = n32103 * n3012 * n301232103 + n31230 * n2103 * n33012221032
	
	return(phi_)
}

phi_m <- function(f) {
  
  phi_ = array(0,7)
  
  m02 = mpq(f,0,2)
  m03 = mpq(f,0,3)
  m11 = mpq(f,1,1)
  m12 = mpq(f,1,2)
  m20 = mpq(f,2,0)
  m21 = mpq(f,2,1)
  m30 = mpq(f,3,0)
  
  m411 = 4*m11
  m4112 = 4*m11^2
  m0312 = m03 + m12
  m2002 = m20 - m02
  m2103 = m21 + m03
  m3012 = m30 + m12
  m20022 = m2002^2
  m21032 = m2103^2
  m30122 = m3012^2
  m30312 = m30 - 3*m12
  m31230 = 3*m12 - m30
  m32103 = 3*m21 - m03
  m303122 = m30312^2
  m321032 = m32103^2
  m30122103 = m30122 - m21032
  m301232103 = m30122 - 3*m21032
  m33012221032 = 3*m30122 - m21032
  
  phi_[1] = m20 + m02
  
  phi_[2] = m20022 + m4112
  
  phi_[3] = m303122 + m321032
  
  phi_[4] = m30122 + m21032
  
  phi_[5] = m30312 * m3012 * m301232103 + m32103 * m2103 * m33012221032
  
  phi_[6] = m2002 * m30122103 + m411 * m3012 * m2103
  
  phi_[7] = m32103 * m3012 * m301232103 + m31230 * m2103 * m33012221032
  
  return(phi_)
}
